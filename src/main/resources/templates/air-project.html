<!DOCTYPE html>
<html lang="en">

<div th:replace="fragments/head :: head('Air Project')"></div>
<!-- Custom styles for this page -->
<link href="vendor/datatables/dataTables.bootstrap4.min.css" rel="stylesheet">

<body id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper">

        <div th:replace="fragments/sliderbar :: sliderbar"></div>


        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">

            <!-- Main Content -->
            <div id="content">

                <div th:replace="fragments/topbar :: topbar"></div>

                <!-- Create/Edit Form -->

                <div class="container-fluid mt-1">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h2 class="text-center">Air Project Management</h2>
                                </div>
                                <div class="card-body">
                                    <!-- Open Modal Button for Adding New Air Project -->
                                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#airProjectModal">
                                        Add New Air Project
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-body">
                                    <!-- List Air Projects DataTable -->
                                    <h3 class="mb-4">List Air Projects</h3>
                                    <table class="table table-striped" id="airProjectTable">
                                        <thead>
                                        <tr>
                                            <th scope="col">ID</th>
                                            <th scope="col">Name</th>
                                            <th scope="col">Description</th>
                                            <th scope="col">Note</th>
                                            <th scope="col">Link Source</th>
                                            <th scope="col">Source</th>
                                            <th scope="col">Status</th>
                                            <th scope="col">Quantity</th>
                                            <th scope="col">Actions</th>
                                        </tr>
                                        </thead>
                                        <tbody id="airProjectList">
                                        <!-- Air Projects will be dynamically added here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <!-- End of Main Content -->

        </div>
        <!-- Profile Modal -->
        <!-- Profile Modal -->
        <div class="modal fade" id="airProjectModal" tabindex="-1" role="dialog" aria-labelledby="airProjectModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="airProjectModalLabel">Air Project Form</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- Create/Edit Air Project Form -->
                        <form id="airProjectForm">
                            <div class="mb-3">
                                <label for="name" class="form-label">Name:</label>
                                <input type="text" class="form-control" id="name">
                            </div>
                            <div class="mb-3">
                                <label for="description">Description:</label>
                                <textarea class="form-control" id="description" style="height: 100px"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="note" class="form-label">Note:</label>
                                <input type="text" class="form-control" id="note" >
                            </div>
                            <div class="mb-3">
                                <label for="linkSource" class="form-label">Link Source:</label>
                                <input type="text" class="form-control" id="linkSource" required>
                            </div>
                            <div class="mb-3">
                                <label for="sourceSelect" class="form-label">Select Source:</label>
                                <select class="form-select custom-select-box" id="sourceSelect" required>
                                    <!-- Sources will be dynamically added here -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="statusSelect" class="form-label">Select Status:</label>
                                <select class="form-select custom-select-box" id="statusSelect" required>
                                    <option value="NEW">New</option>
                                    <option value="DOING">Doing</option>
                                    <option value="PENDING">Pending</option>
                                    <option value="CANCEL">Cancel</option>
                                    <option value="EXPIRED">Expired</option>
                                    <option value="CLOSE">Close</option>
                                </select>
                            </div>
                            <input type="hidden" id="airProjectId">
                            <button type="submit" class="btn btn-primary">Save</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End of Page Wrapper -->

    <!-- Scroll to Top Button-->
    <div th:replace="fragments/bottom :: bottom"></div>
    <!-- Page level plugins -->
    <script src="vendor/datatables/jquery.dataTables.min.js"></script>
    <script src="vendor/datatables/dataTables.bootstrap4.min.js"></script>
    <script>
        $(document).ready(function () {
            // Populate source options in the select box from API
            $.ajax({
                type: "GET",
                url: "api/source/list", // Replace with your API endpoint for sources
                success: function (data) {
                    var sourceSelect = $("#sourceSelect");
                    data.forEach(function (source) {
                        sourceSelect.append(`<option value="${source.id}">${source.name}</option>`);
                    });
                },
                error: function (error) {
                    console.log("Error:", error);
                }
            });

            // DataTable initialization
            var airProjectTable = $('#airProjectTable').DataTable({
                paging: true,
                searching: true,
                ordering: true,
                processing: true,
                serverSide: false, // Set to true if you want server-side processing
                ajax: {
                    url: 'api/air-project/list', // Replace with your API endpoint for air projects
                    type: 'GET',
                    dataSrc: ''
                },
                columns: [
                    { data: 'id' },
                    { data: 'name' },
                    {
                        data: 'description',
                        render: function (data, type, row) {
                            if (type === 'display' || type === 'filter') {
                                return data.length > 30 ? data.substr(0, 30) + '...' : data;
                            }
                            return data;
                        }
                    },
                    { data: 'note',
                        render: function (data, type, row) {
                            if (type === 'display' || type === 'filter') {
                                return data.length > 30 ? data.substr(0, 30) + '...' : data;
                            }
                            return data;
                        }},
                    { data: 'linkSource',
                        render: function (data, type, row) {
                            if (type === 'display' || type === 'filter') {
                                let datasub = data.length > 15 ? data.substr(0, 15) + '...' : data;
                                return '<a href="' + data + '" target="_blank">' + datasub + '</a>';
                            }
                            return '<a href="' + data + '" target="_blank">' + data + '</a>';
                        }},
                    { data: 'status' },
                    { data: 'source.name'},
                    { data: 'process.length'},
                    {
                        data: null,
                        render: function (data, type, row) {
                            return '<button class="btn btn-warning edit-item mr-1" data-id="' + row.id + '" data-toggle="modal" data-target="#airProjectModal"><i class="far fa-edit"></i></button>' +
                                '<button class="btn btn-danger delete-item mr-1" data-id="' + row.id + '"><i class="fas fa-backspace"></i></button>'+
                            '<button class="btn btn-primary lauch-project mr-1" href="' + row.id + '" data-id="' + row.id + '"><i class="fas fa-rocket"></i></button>';
                        }
                    }
                ]
            });

            // Submit form to add or update air project
            $("#airProjectForm").submit(function (event) {
                event.preventDefault();

                // Get form data
                var formData = {
                    id: $("#airProjectId").val(),
                    name: $("#name").val(),
                    description: $("#description").val(),
                    note: $("#note").val(),
                    linkSource: $("#linkSource").val(),
                    source:{
                        id: $("#sourceSelect").val()
                    },
                    status: $("#statusSelect").val()
                };

                // Determine whether to add or update air project
                var isUpdate = formData.id !== "";

                // Send API request to add or update air project
                $.ajax({
                    type: isUpdate ? "PUT" : "POST",
                    url: isUpdate ? "api/air-project/" + formData.id : "api/air-project",
                    contentType: "application/json",
                    data: JSON.stringify(formData),
                    success: function () {
                        // Clear form
                        clearForm();

                        airProjectTable.ajax.reload();
                        airProjectTable.draw();
                        // Close the modal
                        $("#airProjectModal").modal("hide");
                    },
                    error: function (error) {
                        console.log("Error:", error);
                    }
                });
            });

            // Open the modal for editing when clicking on Edit button
            $('#airProjectTable tbody').on('click', 'button.edit-item', function () {
                var data = airProjectTable.row($(this).parents('tr')).data();
                // Populate the form fields with air project data
                $('#airProjectId').val(data.id);
                $('#name').val(data.name);
                $('#description').val(data.description);
                $('#note').val(data.note);
                $('#linkSource').val(data.linkSource);
                $('#sourceSelect').val(data.source.id);
                $('#statusSelect').val(data.status);
                // Change modal title
                $('.modal-title').text('Edit Air Project');
            });

            $('#airProjectTable tbody').on('click', 'button.lauch-project', function () {
                var data = airProjectTable.row($(this).parents('tr')).data();
                window.location.href = "/lauch-project/" + data.id;
            });

            // Delete air project when clicking on Delete button
            $('#airProjectTable tbody').on('click', 'button.delete-item', function () {
                var data = airProjectTable.row($(this).parents('tr')).data();
                var confirmDelete = confirm("Are you sure you want to delete this Air Project?");
                if (confirmDelete) {
                    // Send API request to delete air project
                    $.ajax({
                        type: "DELETE",
                        url: "api/air-project/" + data.id,
                        success: function () {
                            // Draw DataTable to update pagination
                            airProjectTable.ajax.reload();
                            airProjectTable.draw();
                        },
                        error: function (error) {
                            console.log("Error:", error);
                        }
                    });
                }
            });

            // Clear form fields
            function clearForm() {
                $("#airProjectId").val("");
                $("#name").val("");
                $("#description").val("");
                $("#note").val("");
                $("#linkSource").val("");
                $("#sourceSelect").val("");
                $("#statusSelect").val("");
                // Change modal title back to default
                $('.modal-title').text('Air Project Form');
            }
            $('#airProjectModal').on('hidden.bs.modal', function () {
                clearForm();
            })
        });
    </script>
</body>

</html>